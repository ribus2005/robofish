load_module modules/ngx_http_geoip2_module.so;
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        set_real_ip_from 127.0.0.1;
        real_ip_header X-Forwarded-For;

        geoip2 /etc/nginx/GeoLite2-Country.mmdb {
           $geoip2_country_code country iso_code;
        }

        map $geoip2_country_code $allowed_country {
           default 1;
           RU 0;
        }
        log_format geoip '$remote_addr - $geoip2_country_code - "$request"';
        access_log /var/log/nginx/access.log geoip;
        server {
                listen 80;
                server_name localhost;

                 if ($geoip2_country_code = "RU") {
                         return 403 "Access Denied for your country.";
                 }

                 if ($allowed_country = 0) {
                         return 403 "Access denied for your region";
                 }

                 location / {
                         proxy_pass http://localhost:5000;
                         proxy_set_header X-Forwarded-Proto $scheme;
                 }
        }

        sendfile on;
        tcp_nopush on;
        types_hash_max_size 2048;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;
}